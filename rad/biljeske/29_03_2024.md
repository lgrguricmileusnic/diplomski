# 26.3.2024.

Socket iz config jsona ce stvorit docker daemon
- https://docs.docker.com/engine/extend/config/#config-field-descriptions
	- bit ce stvoren u /run/docker/plugins pa onda:

```go

func main() {
	d := driver.Driver{}
	h := network.NewHandler(&d)
	u, err := user.Current()

	if err != nil {
		panic(err)
	}

	gid, err := strconv.Atoi(u.Gid)

	if err != nil {
		panic(err)
	}

	h.ServeUnix("/run/docker/plugins/dockercan.sock", gid)
}

``` 

Ali moze i ovako:
```go
func main() {
	d := driver.Driver{}
	h := network.NewHandler(&d)

	h.ServeTCP("dockercan", "127.0.0.1:1337", sdk.WindowsDefaultDaemonRootDir(), nil)
}
```

**funkcija servetcp automatski ce stvorit .spec file u direktoriju u kojem ce ga docker daemon prepoznat**

Odnosno prilagodjeno:
```go
func main() {
	d := driver.Driver{}
	h := network.NewHandler(&d)

	log.Println("Starting CAN docker network driver at 127.0.0.1:1337")
	err := h.ServeTCP("dockercan", "127.0.0.1:1337", "", nil)

	if err != nil {
		log.Panicln(err)
	}
}
```

Pokretanje bez sudo rezultira u gresci zbog nedostatka prava za stvaranje direktorija u /etc
Nakon sudo:

```
❯ sudo ./bin/netplugin
[sudo] password for lgm: 
2024/03/27 01:03:49 Starting CAN docker network driver at 127.0.0.1:1337
```


```
❯ ls /etc/docker/plugins
dockercan.spec
❯ cat /etc/docker/plugins/dockercan.spec
tcp://127.0.0.1:1337
```

Specificnosti:
- pokretanje ServeTCP s drugim portom azurira spec file
- gasenje s ctrl c ne brise spec file

## 27.3.2024.

### /NetworkPlugin.Join
Na /NetworkPlugin.Join poziv, dogadja se:

*The entries in `InterfaceName` represent actual OS level interfaces that should be moved by LibNetwork into the sandbox; the `SrcName` is the name of the OS level interface that the remote process created, and the `DstPrefix` is a prefix for the name the OS level interface should have after it has been moved into the sandbox (LibNetwork will append an index to make sure the actual name does not collide with others).**
*
Znaci vec jedan kraj vec stvorenog para sucelja treba premaknuti u skriveni ns naseg drivera, a drugi ce premaknuti libnetwork u container:

```
sudo ip link add testif type vxcan peer name testifp 
sudo ip link set dev testif up
sudo ip link set dev testifp up
sudo ip link set testifp netns test
```

I onda s cangw-om ga povezati (primjerice na vcan0), ali iz default namespacea u kojem radi driver:
```
sudo ip netns exec test cangw -A -s vcan0 -d testifp -X -e
```

**ali**

*If no gateway and no default static route is set by the driver in the Join response, LibNetwork will add an additional interface to the sandbox connecting to a default gateway network (a bridge network named docker_gwbridge) and program the default gateway into the sandbox accordingly, pointing to the interface address of the bridge docker_gwbridge.*

I to se trenutno dogadja, probati popraviti!