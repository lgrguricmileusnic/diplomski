# Biljeske 19.1.2024

Pitanja:
- dockeriziranje
	- svaki ECU je zasebni container?
	- sve u jednom containeru?
	- mogu li se u docker containerima uopce stvarati vcan sucelja bez privilegiranog nacina?
		- ako mogu, mozemo koristiti kombinaciju can gw-a i vxcana za povezivanje izmedju containera
		- inace nema smisla, bolje je samo stvoriti vcanove na hostu i raditi sve u host network namespaceu?
- sto zapravo korisnik simulatora treba moci vidjeti?
	- ako se koriste vcan sucelja na hostu za CAN sabirnice, korisnik ima pristup svim sabirnicama preko host network namespacea
		- mozda ne bi bilo lose korisnika odvojiti u zasebni container iz kojeg napada ili povezati samo sabirnice kojima ima pristup na vcan sucelje na hostu pomocu vxcana
	- treba imati na umu da se zapravo ne pokusavaju kompromitirati sami containeri nego simulirani ECU-i
		- nije cilj dobiti shell na containeru nego iskoristiti ranjivosti u programima ECU-a putem CAN-a i aplikacijskih protokola povrh CAN-a

Neke bitne stvari:
- docker compose rjesava networking, ali samo za TCP/UDP
	- https://www.docker.com/blog/how-docker-desktop-networking-works-under-the-hood/
	- tuneliranje preko IP-a
		- https://agill.xyz/tunneling-can
		- docker network driver
			- https://gitlab.com/chgans/can4docker
			- svidja mi se ovaj pristup, ali je vise u PoC fazi
			- u principu opet tuneliranje preko TCP-a, samo napravljeno kao docker network driver
	- ako se moze koristiti vcan, nema smisla koristiti CAN tunel preko IP-a
- kernel network namespaces
	- https://blogs.igalia.com/dpino/2016/04/10/network-namespaces/
	- https://blog.scottlowe.org/2013/09/04/introducing-linux-network-namespaces/
	- http://www.opencloudblog.com/?p=66
	- https://marc.info/?l=linux-can&m=149046502301622&w=2
	- https://developers.redhat.com/blog/2018/10/22/introduction-to-linux-interfaces-for-virtual-networking#vxcan
	- network namespaceovi docker containera su imenovani po PID-u containera

## Moguce izvedbe drugi dio

### Simulator u jednom containeru
- simulator je unutar jednog containera, kao i vcan sucelja koja koristi kao sabirnice
- sabirnice (vcan sucelja) kojima korisnik treba imati pristup proslijedjena su vxcan-om
- cangw koristi se za povezivanje sabirnica i filtriranje poruka izmedju njih te za povezivanje vxcan i vcan sucelja

![[koncept1.jpg]]


Modularno povezivanje GUI-a i kontrola:
- primjerice AGL ploca s instrumentima
- moze se koristiti docker compose i bridge izmedju containera koji stvara
- svaki container koji zeli komunicirati s GUI-jem moze to dodatno implementirati
	- primjerice, ECU motora moze komunicirati brzinu AGL ploci s instrumentima

Dodatno se moze povezati pravi hardver na simulator ako hardver ima socketcan driver.

![[koncept1_zoom_out.jpg]]

### Svaki ECU u svom containeru
- svaki ECU u svom containeru, svaki container ima specificiran binary koji treba pokretat
- sve se podize s docker composeom
	- CAN komunikacija zasebnom skriptom/programom prema konfiguraciji (podizanje sucelja, can gw)
	- tcp komunikaciju podize docker compose
- 
![[koncept2.png]]


## Testiranje docker + vcan + vxcan

https://stackoverflow.com/questions/42964839/what-is-the-most-light-weight-base-image-i-can-use-to-build-a-dockerfile

*Alpine: This is a minimal distribution, based on busybox, but with the `apk` package manager. The small size comes at a cost, things like glibc are not included, preferring the musl libc implementation instead. You will find that many of the official images are based on Alpine, so inside of the container ecosystem, this is a very popular option.*

https://pkgs.alpinelinux.org/packages?name=can-utils
- alpine ima can-utils preko apk-a i lightweight je

``` Host
sudo docker pull alpine
docker run -dit alpine
docker attach <ime-containera>
```

```Container
apk add can-utils
```

### vcan u containeru

Dodavanje vcan sucelja ne radi po defaultu:
```
b535ea53f8b0:/# sudo ip link add dev vcan0 type vcan
ip: RTNETLINK answers: Operation not permitted
```

**Potrebno je dodati NET_ADMIN capability**
- https://docs.docker.com/engine/reference/run/#runtime-privilege-and-linux-capabilities
- For interacting with the network stack, instead of using `--privileged` they should use `--cap-add=NET_ADMIN` to modify the network interfaces.

i onda sve radi

**stvoreno vcan0 sucelje se ne vidi na hostu, kao sto se ni vcan sucelja hosta ne vide u containeru**
